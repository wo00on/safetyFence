# 위치 수집 및 저장 주기 종합 정리

## 📋 목차
1. [문서 간 주요 차이점](#문서-간-주요-차이점)
2. [위치 수집 주기 정리](#위치-수집-주기-정리)
3. [위치 전송 주기 정리](#위치-전송-주기-정리)
4. [위치 저장 주기 정리](#위치-저장-주기-정리)
5. [전체 데이터 흐름](#전체-데이터-흐름)
6. [권장 설정](#권장-설정)
7. [문서 통합 권장사항](#문서-통합-권장사항)

---

## 문서 간 주요 차이점

### 1. 문서 목적의 차이

| 구분 | React_WebSocket_서비스_종합_가이드 | WebSocket_실시간_위치_공유_시스템 |
|------|-------------------------------------|-----------------------------------|
| **관점** | Frontend (React Native) | Backend (Spring Boot) |
| **초점** | 클라이언트 구현 및 통합 | 서버 아키텍처 및 최적화 |
| **대상** | 모바일 앱 개발자 | 백엔드 개발자 |
| **깊이** | WebSocket 사용법, Context API | 캐싱, 조건부 저장, 권한 검증 |

### 2. 기술 스택 차이

#### Frontend 문서 (React_WebSocket_서비스_종합_가이드)
```
✅ 순수 WebSocket (React Native 네이티브 지원)
✅ @stomp/stompjs
✅ Expo Location
✅ Expo Task Manager
✅ Expo Sensors (Accelerometer)
❌ SockJS 제거됨
```

#### Backend 문서 (WebSocket_실시간_위치_공유_시스템)
```
⚠️ SockJS 언급됨 (실제 코드와 불일치)
✅ Spring WebSocket (STOMP)
✅ Caffeine Cache
✅ Spring Async
✅ MySQL
```

### 3. 주요 불일치 사항

#### 🔴 Critical: WebSocket 연결 방식

| 항목 | Frontend 문서 (실제 코드) | Backend 문서 (오래된 정보) |
|------|---------------------------|---------------------------|
| **연결 방식** | 순수 WebSocket (`brokerURL`) | SockJS fallback 언급 |
| **실제 구현** | `brokerURL: wsUrl` | ~~`new SockJS()`~~ |
| **코드 위치** | websocketService.ts:51-56 | WebSocketConfig.java:206 |

**문제점**: Backend 문서가 오래된 정보를 포함하고 있어 실제 구현과 불일치

#### 🟡 Important: 위치 수집 주기

| 문서 | 포그라운드 | 백그라운드 |
|------|-----------|-----------|
| **Frontend** | 2초 | 15초 |
| **Backend** | 2초 (일치) | 15초 (일치) |

**일치**: 양쪽 문서 모두 동일한 주기 사용

#### 🟢 Minor: 구독 전략

| 항목 | Frontend 문서 | Backend 문서 |
|------|--------------|--------------|
| **구독 방식** | 활성화 시 구독 (간략 설명) | 활성화 시 구독 (상세 설명) |
| **권한 검증** | 언급 없음 | WebSocketAuthInterceptor 상세 |
| **캐싱** | 언급 없음 | Caffeine Cache 상세 |

---

## 위치 수집 주기 정리

### Frontend: Location Tracking

#### 1. 포그라운드 위치 수집
```typescript
// LocationContext.tsx:113-133
Location.watchPositionAsync({
  accuracy: Location.Accuracy.High,
  timeInterval: 2000,      // ⏱️ 2초마다 수집
  distanceInterval: 10,    // 📏 10미터 이동 시
})
```

**특징**:
- ✅ **주기**: 2초마다 OR 10m 이동 시
- ✅ **정확도**: High (GPS 사용)
- ✅ **실시간성**: 매우 높음
- ✅ **배터리**: 중간 소모

#### 2. 백그라운드 위치 수집
```typescript
// backgroundLocationService.ts:117-128
Location.startLocationUpdatesAsync(BACKGROUND_LOCATION_TASK, {
  accuracy: Location.Accuracy.High,
  timeInterval: 15000,     // ⏱️ 15초마다 수집
  distanceInterval: 10,    // 📏 10미터 이동 시
})
```

**특징**:
- ✅ **주기**: 15초마다 OR 10m 이동 시
- ✅ **정확도**: High (GPS 사용)
- ✅ **실시간성**: 중간
- ✅ **배터리**: 최적화됨 (포그라운드 대비 87.5% 절감)

### 수집 주기 비교

| 모드 | 시간 간격 | 거리 간격 | 시간당 수집 횟수 | 배터리 소모 |
|------|----------|----------|----------------|------------|
| **포그라운드** | 2초 | 10m | 최대 1,800회 | 높음 |
| **백그라운드** | 15초 | 10m | 최대 240회 | 낮음 (87.5% 절감) |

**배터리 최적화 전략** (LocationContext.tsx:192-228):
```typescript
Accelerometer로 움직임 감지
→ 움직임 없으면 10분 후 백그라운드 추적 중지
→ 다시 움직이면 백그라운드 추적 재개
```

---

## 위치 전송 주기 정리

### Frontend → Backend 전송

#### 1. 포그라운드 위치 전송 (WebSocket)
```typescript
// LocationContext.tsx:276-311
useEffect(() => {
  // 즉시 첫 위치 전송
  websocketService.sendLocation({...});

  // 2초마다 위치 전송
  const interval = setInterval(() => {
    websocketService.sendLocation({...});
  }, 2000);
}, [currentLocation, isTracking, isWebSocketConnected]);
```

**특징**:
- ✅ **주기**: 2초마다 전송
- ✅ **프로토콜**: WebSocket (STOMP)
- ✅ **즉시 전송**: 연결 시 최초 1회 즉시 전송
- ✅ **실시간성**: 최고

#### 2. 백그라운드 위치 전송

##### 2-1. WebSocket 우선
```typescript
// backgroundLocationService.ts:51-61
if (websocketService.isConnected()) {
  websocketService.sendLocation({...});  // ⏱️ 15초마다 (백그라운드 수집 주기)
}
```

##### 2-2. HTTP POST Fallback
```typescript
// backgroundLocationService.ts:63-87
else {
  fetch(`${Global.URL}/location`, {
    method: 'POST',
    body: JSON.stringify({...})
  });
}
```

**특징**:
- ✅ **주기**: 15초마다 전송 (백그라운드 수집 주기와 동일)
- ✅ **우선순위**: WebSocket > HTTP POST
- ✅ **안정성**: 이중화 메커니즘

### Backend → Frontend 전송 (구독자에게)

```java
// LocationWebSocketController.java
messagingTemplate.convertAndSend(
  "/topic/location/" + userNumber,
  location
);
```

**특징**:
- ✅ **주기**: 이용자가 위치 전송할 때마다 즉시 브로드캐스트
- ✅ **프로토콜**: WebSocket (STOMP)
- ✅ **대상**: 해당 이용자를 구독 중인 보호자들
- ✅ **지연**: < 100ms (실시간)

### 전송 주기 요약

| 시나리오 | 전송 주기 | 프로토콜 | 특징 |
|---------|----------|---------|------|
| **포그라운드 → 서버** | 2초 | WebSocket | 실시간, 즉시 첫 전송 |
| **백그라운드 → 서버** | 15초 | WebSocket/HTTP | 배터리 절약 |
| **서버 → 구독자** | 즉시 | WebSocket | < 100ms 지연 |

---

## 위치 저장 주기 정리

### Backend: Database 저장

#### 1. 저장 전략 (전략 패턴)

```java
// DistanceBasedSaveStrategy.java
public boolean shouldSave(UserLocation previous, LocationUpdateDto current) {
  // 1️⃣ 첫 위치 → 무조건 저장
  if (previous == null) return true;

  // 2️⃣ 거리 조건: 100m 이상 이동
  double distance = calculateDistance(...);
  if (distance >= 100.0) return true;

  // 3️⃣ 시간 조건: 1분 이상 경과
  long timeDiff = current.getTimestamp() - previous.getTimestamp();
  if (timeDiff >= 60_000) return true;

  // 조건 미충족 → 저장 안 함
  return false;
}
```

#### 2. 저장 조건

| 조건 | 설명 | 결과 |
|------|------|------|
| **첫 위치** | 이전 위치 없음 | ✅ 저장 |
| **거리 조건** | Haversine 거리 ≥ 100m | ✅ 저장 |
| **시간 조건** | 마지막 저장 후 ≥ 60초 | ✅ 저장 |
| **기타** | 위 조건 모두 미충족 | ❌ 저장 안 함 |

#### 3. 저장 빈도 분석

##### 포그라운드 (2초 전송)
```
전송: 2초마다 → 시간당 1,800회
저장: 조건부 → 시간당 최대 60회 (시간 조건)
절감율: 96.7%
```

##### 백그라운드 (15초 전송)
```
전송: 15초마다 → 시간당 240회
저장: 조건부 → 시간당 최대 60회 (시간 조건)
절감율: 75%
```

##### 일일 저장 횟수 예측
```
정지 상태 (거리 조건 미충족):
→ 시간 조건만: 60회/시간 × 24시간 = 1,440회/일

이동 중 (평균 속도 4km/h 걷기):
→ 100m마다 저장: ~40회/시간 × 8시간 = 320회/일
→ 정지: 60회/시간 × 16시간 = 960회/일
→ 총: 1,280회/일

DB 부하: 매우 낮음 (1일 1,280 ~ 1,440 레코드)
```

#### 4. 비동기 처리

```java
// LocationService.java
@Async
@Transactional
public void saveLocationIfNeeded(LocationUpdateDto locationDto) {
  // 별도 스레드에서 실행
  // WebSocket 메시지 전송과 독립적
}
```

**장점**:
- ✅ 실시간 전송에 영향 없음 (지연 < 10ms)
- ✅ DB 저장 실패해도 WebSocket 정상 동작
- ✅ 성능 최적화

---

## 전체 데이터 흐름

### 이용자 (USER) 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                        이용자 앱                                  │
├─────────────────────────────────────────────────────────────────┤
│  📍 위치 수집 (Location.watchPosition)                          │
│     ├─ 포그라운드: 2초 간격                                      │
│     └─ 백그라운드: 15초 간격                                     │
│                        ↓                                         │
│  📤 위치 전송 (WebSocket)                                        │
│     ├─ 포그라운드: 2초마다 전송                                  │
│     └─ 백그라운드: 15초마다 전송 (또는 HTTP POST)                │
└─────────────────────────────────────────────────────────────────┘
                           ↓ WebSocket /app/location
┌─────────────────────────────────────────────────────────────────┐
│                        Backend Server                            │
├─────────────────────────────────────────────────────────────────┤
│  1️⃣ LocationWebSocketController.updateLocation()               │
│     └─ 세션에서 userNumber 추출                                 │
│                        ↓                                         │
│  2️⃣ LocationCacheService.updateLocation()                      │
│     └─ Caffeine Cache에 최신 위치 저장 (1개만)                  │
│                        ↓                                         │
│  3️⃣ messagingTemplate.convertAndSend()                         │
│     └─ /topic/location/{userNumber}로 브로드캐스트              │
│                        ↓                                         │
│  4️⃣ LocationService.saveLocationIfNeeded() [@Async]            │
│     ├─ 거리 조건: ≥ 100m 이동                                   │
│     ├─ 시간 조건: ≥ 60초 경과                                   │
│     └─ 조건 충족 시 DB 저장 (96.7% 절감)                        │
└─────────────────────────────────────────────────────────────────┘
                           ↓ WebSocket /topic/location/{userNumber}
┌─────────────────────────────────────────────────────────────────┐
│                        보호자 앱                                  │
├─────────────────────────────────────────────────────────────────┤
│  📍 위치 수신 (WebSocket Subscribe)                             │
│     └─ 2초마다 실시간 업데이트 (이용자 전송 주기)                │
│                        ↓                                         │
│  🗺️ 지도 업데이트                                                │
│     └─ 마커 위치 즉시 변경 (< 100ms 지연)                       │
└─────────────────────────────────────────────────────────────────┘
```

### 보호자 (SUPPORTER) 구독 흐름

```
┌─────────────────────────────────────────────────────────────────┐
│                        보호자 앱                                  │
├─────────────────────────────────────────────────────────────────┤
│  1️⃣ Link 목록 조회 (HTTP GET /links)                           │
│     └─ 연결된 이용자 목록 표시                                   │
│                        ↓                                         │
│  2️⃣ 특정 이용자 선택                                            │
│     └─ 활성화 시 구독 방식 (1명만 구독)                          │
│                        ↓                                         │
│  3️⃣ WebSocket Subscribe                                        │
│     └─ /topic/location/{targetUserNumber}                       │
└─────────────────────────────────────────────────────────────────┘
                           ↓ SUBSCRIBE /topic/location/{userNumber}
┌─────────────────────────────────────────────────────────────────┐
│                        Backend Server                            │
├─────────────────────────────────────────────────────────────────┤
│  1️⃣ WebSocketAuthInterceptor (권한 검증)                        │
│     ├─ SUBSCRIBE 명령 가로채기                                  │
│     ├─ Link 관계 확인: hasLink(subscriber, target)              │
│     └─ 권한 없으면 return null (차단)                            │
│                        ↓ 권한 체크 통과                          │
│  2️⃣ WebSocketEventListener (SessionSubscribeEvent)             │
│     ├─ 캐시에서 최신 위치 조회                                   │
│     └─ 즉시 전송 (있는 경우)                                     │
└─────────────────────────────────────────────────────────────────┘
                           ↓ MESSAGE (캐시된 위치)
┌─────────────────────────────────────────────────────────────────┐
│                        보호자 앱                                  │
├─────────────────────────────────────────────────────────────────┤
│  📍 즉시 위치 표시 (< 200ms)                                     │
│     └─ 캐시된 최신 위치 마커 표시                                │
│                        ↓                                         │
│  📍 실시간 업데이트                                              │
│     └─ 이용자가 전송할 때마다 즉시 수신                           │
└─────────────────────────────────────────────────────────────────┘
```

---

## 권장 설정

### 포그라운드 (앱 활성 상태)

| 설정 항목 | 권장 값 | 이유 |
|----------|--------|------|
| **위치 수집 간격** | 2초 | 실시간 추적 필요 |
| **위치 전송 간격** | 2초 | 수집과 동시 전송 (지연 최소화) |
| **거리 필터** | 10m | 작은 움직임도 감지 |
| **정확도** | High | GPS 우선 사용 |
| **배터리 소모** | 중간 | 실시간성 우선 |

### 백그라운드 (앱 비활성 상태)

| 설정 항목 | 권장 값 | 이유 |
|----------|--------|------|
| **위치 수집 간격** | 15초 | 배터리 절약 |
| **위치 전송 간격** | 15초 | 수집과 동시 전송 |
| **거리 필터** | 10m | 유의미한 이동만 감지 |
| **정확도** | High | 안전 추적에 필요 |
| **배터리 소모** | 낮음 | 87.5% 절감 |
| **움직임 감지** | 활성화 | 정지 시 10분 후 중지 |

### 서버 저장 (DB)

| 설정 항목 | 권장 값 | 이유 |
|----------|--------|------|
| **거리 조건** | 100m | 의미 있는 이동만 저장 |
| **시간 조건** | 60초 | 정지 상태에서도 주기적 저장 |
| **비동기 처리** | 활성화 | 실시간 전송과 분리 |
| **캐시 TTL** | 5분 | 재연결 시 빠른 복구 |
| **캐시 최대 크기** | 10,000명 | 메모리 540KB (가벼움) |

### 네트워크 최적화

| 설정 항목 | 권장 값 | 이유 |
|----------|--------|------|
| **Heartbeat** | 10초 | 연결 유지 (모바일 최적화) |
| **재연결 시도** | 최대 5회 | 네트워크 불안정 대응 |
| **재연결 간격** | 3초 | 빠른 복구 |
| **HTTP Fallback** | 활성화 | 백그라운드 안정성 |

---

## 성능 지표

### 1. 실시간성

| 시나리오 | 지연 시간 | 측정 방법 |
|---------|----------|----------|
| **포그라운드 전송** | < 100ms | 위치 수집 → WebSocket 전송 |
| **백그라운드 전송** | < 200ms | TaskManager → WebSocket/HTTP |
| **구독자 수신** | < 100ms | 서버 브로드캐스트 → 클라이언트 |
| **최초 구독 시** | < 200ms | 캐시 조회 → 즉시 전송 |
| **전체 지연** | < 2.3초 | 이용자 이동 → 보호자 화면 표시 |

### 2. 배터리 소모

| 모드 | 시간당 소모율 | 1일 소모율 | 최적화 전략 |
|------|-------------|-----------|------------|
| **포그라운드** | ~5% | ~120% (불가능) | 필요 시에만 사용 |
| **백그라운드** | ~0.5% | ~12% | 움직임 감지 활용 |
| **정지 상태** | ~0.1% | ~2.4% | 10분 후 자동 중지 |

### 3. 네트워크 대역폭

| 방향 | 메시지 크기 | 전송 주기 | 대역폭 (1명) | 대역폭 (1,000명) |
|------|------------|----------|-------------|----------------|
| **업스트림** (포그라운드) | 100 bytes | 2초 | 50 bytes/s | 50 KB/s |
| **업스트림** (백그라운드) | 100 bytes | 15초 | 6.7 bytes/s | 6.7 KB/s |
| **다운스트림** | 100 bytes | 2초 | 50 bytes/s × 구독자 수 | 가변 |

### 4. DB 부하

| 항목 | 전체 저장 | 조건부 저장 | 절감율 |
|------|----------|-----------|--------|
| **포그라운드** | 1,800회/시간 | 60회/시간 | 96.7% |
| **백그라운드** | 240회/시간 | 60회/시간 | 75% |
| **1일** | 43,200회 | 1,440회 | 96.7% |
| **1,000명 × 1일** | 43,200,000회 | 1,440,000회 | 96.7% |

### 5. 메모리 사용량

| 컴포넌트 | 1,000명 | 10,000명 | 비고 |
|---------|--------|---------|------|
| **Caffeine Cache** | 54 KB | 540 KB | 매우 가벼움 |
| **WebSocket 세션** | 1 MB | 10 MB | 세션당 1KB |
| **총 메모리** | 1.05 MB | 10.5 MB | 충분히 효율적 |

---

## 문서 통합 권장사항

### 1. 불일치 해결

#### 🔴 Critical: SockJS 제거
**현재 상태**:
- Frontend 문서: ✅ 순수 WebSocket 사용 (실제 코드와 일치)
- Backend 문서: ❌ SockJS 언급 (오래된 정보)

**권장 조치**:
```markdown
Backend 문서에서 SockJS 관련 내용 모두 제거:
- WebSocketConfig 예제에서 .withSockJS() 제거
- Frontend 통합 가이드에서 SockJS 예제 제거
- "React Native는 네이티브 WebSocket 지원" 명확히 명시
```

### 2. 문서 역할 명확화

#### Frontend 문서 (React_WebSocket_서비스_종합_가이드)
**포커스**:
- ✅ WebSocket 클라이언트 구현
- ✅ Location API 사용법
- ✅ 백그라운드 추적 설정
- ✅ 배터리 최적화 전략
- ✅ Context API 통합

**추가 필요**:
- ❌ 권한 검증 프로세스 설명 (Backend 연동 관점)
- ❌ 캐싱 동작 설명 (구독 시 즉시 응답 이유)

#### Backend 문서 (WebSocket_실시간_위치_공유_시스템)
**포커스**:
- ✅ WebSocket 서버 아키텍처
- ✅ 권한 검증 (WebSocketAuthInterceptor)
- ✅ 캐싱 전략 (Caffeine)
- ✅ 조건부 저장 (전략 패턴)
- ✅ 성능 최적화

**수정 필요**:
- ❌ SockJS 관련 내용 제거
- ❌ Frontend 연동 예제 업데이트 (순수 WebSocket)

---

## 요약

### ✅ 일치하는 부분
- 위치 수집 주기: 포그라운드 2초, 백그라운드 15초
- 위치 전송 주기: 포그라운드 2초, 백그라운드 15초
- 전반적인 시스템 아키텍처 및 데이터 흐름

### ❌ 불일치하는 부분
- **SockJS 사용 여부**: Backend 문서가 오래된 정보 포함
- **권한 검증 설명**: Frontend 문서에 누락
- **캐싱 메커니즘**: Frontend 문서에 누락

### 📊 핵심 주기 정리

| 구분 | 포그라운드 | 백그라운드 | 서버 저장 |
|------|-----------|-----------|----------|
| **수집** | 2초 | 15초 | - |
| **전송** | 2초 | 15초 | - |
| **저장** | - | - | 조건부 (100m OR 60초) |
| **구독자 수신** | 즉시 (< 100ms) | 즉시 (< 100ms) | - |

### 🎯 최적화 효과

| 항목 | 최적화 전 | 최적화 후 | 절감율 |
|------|----------|----------|--------|
| **배터리** | ~5%/시간 | ~0.5%/시간 | 90% |
| **DB 저장** | 1,800회/시간 | 60회/시간 | 96.7% |
| **네트워크** | 동일 | 동일 | - |
| **메모리** | 동일 | 540KB (10,000명) | 효율적 |

---

**작성일**: 2025-11-20
**작성자**: Claude Code
**목적**: 두 WebSocket 문서 간 차이점 분석 및 위치 수집/저장 주기 종합 정리
